name: Build & Deploy CTFd to K3s

on:
  push:
    branches: ["master"]   # change if needed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ------------------------
      # 1. CHECKOUT CODE
      # ------------------------
      - name: Checkout
        uses: actions/checkout@v3

      # ------------------------
      # 2. Build & Push Docker Image
      # ------------------------
      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Image
        uses: docker/build-push-action@v3
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/ctfd:latest

      # ------------------------
      # 3. SSH into EC2 + Deploy on K3s
      # ------------------------
      - name: Install SSH Key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.K3S_SSH_PRIVATE_KEY }}

      - name: Deploy to K3s
        run: |
            # Copy manifests to EC2
            ls -la ${{ github.workspace }}/manifests

             # Make sure the destination folder exists on EC2
            ssh -o StrictHostKeyChecking=no ${{ secrets.K3S_SSH_USER }}@${{ secrets.K3S_SSH_HOST }} "mkdir -p ~/ctfd"

            # Copy to EC2
            scp -o StrictHostKeyChecking=no -r ${{ github.workspace }}/manifests ${{ secrets.K3S_SSH_USER }}@${{ secrets.K3S_SSH_HOST }}:~/ctfd/
            
            # SSH into EC2 and deploy
            ssh -o StrictHostKeyChecking=no ${{ secrets.K3S_SSH_USER }}@${{ secrets.K3S_SSH_HOST }} << EOF
            echo "ðŸ”¹ Applying manifestsâ€¦"
            sudo kubectl --kubeconfig=${{ secrets.K3S_KUBECONFIG_PATH }} apply -f ~/ctfd/manifests/

            echo "ðŸ”¹ Waiting for deployment to be readyâ€¦"
            sleep 10

            echo "ðŸ”¹ Updating deployment imageâ€¦"
            if sudo kubectl --kubeconfig=${{ secrets.K3S_KUBECONFIG_PATH }} -n ctfd get deployment ctfd; then
                sudo kubectl --kubeconfig=${{ secrets.K3S_KUBECONFIG_PATH }} -n ctfd set image deployment/ctfd \
                    ctfd=${{ secrets.DOCKERHUB_USERNAME }}/ctfd:latest --record

                echo "ðŸ”¹ Restarting deployment for rolloutâ€¦"
                sudo kubectl --kubeconfig=${{ secrets.K3S_KUBECONFIG_PATH }} -n ctfd rollout restart deployment/ctfd
                echo "ðŸ”¹ Checking rollout statusâ€¦"
                sudo kubectl --kubeconfig=${{ secrets.K3S_KUBECONFIG_PATH }} -n ctfd rollout status deployment/ctfd
            fi
            EOF

